{"ast":null,"code":"\"use strict\";\n\nvar __classPrivateFieldSet = this && this.__classPrivateFieldSet || function (receiver, state, value, kind, f) {\n  if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n  return kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value), value;\n};\n\nvar __classPrivateFieldGet = this && this.__classPrivateFieldGet || function (receiver, state, kind, f) {\n  if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n  if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n  return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nvar _SafeFactory_contractNetworks, _SafeFactory_isL1SafeMasterCopy, _SafeFactory_safeVersion, _SafeFactory_ethAdapter, _SafeFactory_safeProxyFactoryContract, _SafeFactory_gnosisSafeContract;\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst ethereumjs_util_1 = require(\"ethereumjs-util\");\n\nconst config_1 = require(\"../contracts/config\");\n\nconst safeDeploymentContracts_1 = require(\"../contracts/safeDeploymentContracts\");\n\nconst Safe_1 = __importDefault(require(\"../Safe\"));\n\nconst constants_1 = require(\"../utils/constants\");\n\nconst utils_1 = require(\"./utils\");\n\nclass SafeFactory {\n  constructor() {\n    _SafeFactory_contractNetworks.set(this, void 0);\n\n    _SafeFactory_isL1SafeMasterCopy.set(this, void 0);\n\n    _SafeFactory_safeVersion.set(this, void 0);\n\n    _SafeFactory_ethAdapter.set(this, void 0);\n\n    _SafeFactory_safeProxyFactoryContract.set(this, void 0);\n\n    _SafeFactory_gnosisSafeContract.set(this, void 0);\n  }\n\n  static async create(_ref) {\n    let {\n      ethAdapter,\n      safeVersion = config_1.SAFE_LAST_VERSION,\n      isL1SafeMasterCopy = false,\n      contractNetworks\n    } = _ref;\n    const safeFactorySdk = new SafeFactory();\n    await safeFactorySdk.init({\n      ethAdapter,\n      safeVersion,\n      isL1SafeMasterCopy,\n      contractNetworks\n    });\n    return safeFactorySdk;\n  }\n\n  async init(_ref2) {\n    let {\n      ethAdapter,\n      safeVersion,\n      isL1SafeMasterCopy,\n      contractNetworks\n    } = _ref2;\n\n    __classPrivateFieldSet(this, _SafeFactory_ethAdapter, ethAdapter, \"f\");\n\n    __classPrivateFieldSet(this, _SafeFactory_safeVersion, safeVersion, \"f\");\n\n    __classPrivateFieldSet(this, _SafeFactory_isL1SafeMasterCopy, isL1SafeMasterCopy, \"f\");\n\n    __classPrivateFieldSet(this, _SafeFactory_contractNetworks, contractNetworks, \"f\");\n\n    const chainId = await __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").getChainId();\n    const customContracts = contractNetworks === null || contractNetworks === void 0 ? void 0 : contractNetworks[chainId];\n\n    __classPrivateFieldSet(this, _SafeFactory_safeProxyFactoryContract, await (0, safeDeploymentContracts_1.getProxyFactoryContract)({\n      ethAdapter,\n      safeVersion,\n      chainId,\n      customContracts\n    }), \"f\");\n\n    __classPrivateFieldSet(this, _SafeFactory_gnosisSafeContract, await (0, safeDeploymentContracts_1.getSafeContract)({\n      ethAdapter,\n      safeVersion,\n      chainId,\n      isL1SafeMasterCopy,\n      customContracts\n    }), \"f\");\n  }\n\n  getEthAdapter() {\n    return __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\");\n  }\n\n  getSafeVersion() {\n    return __classPrivateFieldGet(this, _SafeFactory_safeVersion, \"f\");\n  }\n\n  getAddress() {\n    return __classPrivateFieldGet(this, _SafeFactory_safeProxyFactoryContract, \"f\").getAddress();\n  }\n\n  async getChainId() {\n    return __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").getChainId();\n  }\n\n  async encodeSetupCallData(_ref3) {\n    let {\n      owners,\n      threshold,\n      to = constants_1.ZERO_ADDRESS,\n      data = constants_1.EMPTY_DATA,\n      fallbackHandler,\n      paymentToken = constants_1.ZERO_ADDRESS,\n      payment = 0,\n      paymentReceiver = constants_1.ZERO_ADDRESS\n    } = _ref3;\n\n    var _a;\n\n    let fallbackHandlerAddress;\n\n    if (fallbackHandler) {\n      fallbackHandlerAddress = fallbackHandler;\n    } else {\n      const chainId = await __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").getChainId();\n      const customContracts = (_a = __classPrivateFieldGet(this, _SafeFactory_contractNetworks, \"f\")) === null || _a === void 0 ? void 0 : _a[chainId];\n      const fallbackHandlerContract = await (0, safeDeploymentContracts_1.getCompatibilityFallbackHandlerContract)({\n        ethAdapter: __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\"),\n        safeVersion: __classPrivateFieldGet(this, _SafeFactory_safeVersion, \"f\"),\n        chainId,\n        customContracts\n      });\n      fallbackHandlerAddress = fallbackHandlerContract.getAddress();\n    }\n\n    return __classPrivateFieldGet(this, _SafeFactory_gnosisSafeContract, \"f\").encode('setup', [owners, threshold, to, data, fallbackHandlerAddress, paymentToken, payment, paymentReceiver]);\n  }\n\n  async predictSafeAddress(_ref4) {\n    let {\n      safeAccountConfig,\n      safeDeploymentConfig\n    } = _ref4;\n    (0, utils_1.validateSafeAccountConfig)(safeAccountConfig);\n    (0, utils_1.validateSafeDeploymentConfig)(safeDeploymentConfig);\n\n    const from = __classPrivateFieldGet(this, _SafeFactory_safeProxyFactoryContract, \"f\").getAddress();\n\n    const initializer = await this.encodeSetupCallData(safeAccountConfig);\n    const saltNonce = safeDeploymentConfig.saltNonce;\n    const encodedNonce = (0, ethereumjs_util_1.toBuffer)(__classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").encodeParameters(['uint256'], [saltNonce])).toString('hex');\n    const salt = (0, ethereumjs_util_1.keccak256)((0, ethereumjs_util_1.toBuffer)('0x' + (0, ethereumjs_util_1.keccak256)((0, ethereumjs_util_1.toBuffer)(initializer)).toString('hex') + encodedNonce));\n    const proxyCreationCode = await __classPrivateFieldGet(this, _SafeFactory_safeProxyFactoryContract, \"f\").proxyCreationCode();\n    const constructorData = (0, ethereumjs_util_1.toBuffer)(__classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").encodeParameters(['address'], [__classPrivateFieldGet(this, _SafeFactory_gnosisSafeContract, \"f\").getAddress()])).toString('hex');\n    const initCode = proxyCreationCode + constructorData;\n    const proxyAddress = '0x' + (0, ethereumjs_util_1.generateAddress2)((0, ethereumjs_util_1.toBuffer)(from), (0, ethereumjs_util_1.toBuffer)(salt), (0, ethereumjs_util_1.toBuffer)(initCode)).toString('hex');\n    return __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").getChecksummedAddress(proxyAddress);\n  }\n\n  async deploySafe(_ref5) {\n    let {\n      safeAccountConfig,\n      safeDeploymentConfig,\n      options,\n      callback\n    } = _ref5;\n\n    var _a;\n\n    (0, utils_1.validateSafeAccountConfig)(safeAccountConfig);\n\n    if (safeDeploymentConfig) {\n      (0, utils_1.validateSafeDeploymentConfig)(safeDeploymentConfig);\n    }\n\n    const signerAddress = await __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").getSignerAddress();\n\n    if (!signerAddress) {\n      throw new Error('EthAdapter must be initialized with a signer to use this method');\n    }\n\n    const initializer = await this.encodeSetupCallData(safeAccountConfig);\n    const saltNonce = (_a = safeDeploymentConfig === null || safeDeploymentConfig === void 0 ? void 0 : safeDeploymentConfig.saltNonce) !== null && _a !== void 0 ? _a : (Date.now() * 1000 + Math.floor(Math.random() * 1000)).toString();\n\n    if ((options === null || options === void 0 ? void 0 : options.gas) && (options === null || options === void 0 ? void 0 : options.gasLimit)) {\n      throw new Error('Cannot specify gas and gasLimit together in transaction options');\n    }\n\n    const safeAddress = await __classPrivateFieldGet(this, _SafeFactory_safeProxyFactoryContract, \"f\").createProxy({\n      safeMasterCopyAddress: __classPrivateFieldGet(this, _SafeFactory_gnosisSafeContract, \"f\").getAddress(),\n      initializer,\n      saltNonce,\n      options: {\n        from: signerAddress,\n        ...options\n      },\n      callback\n    });\n    const isContractDeployed = await __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").isContractDeployed(safeAddress);\n\n    if (!isContractDeployed) {\n      throw new Error('SafeProxy contract is not deployed on the current network');\n    }\n\n    const safe = await Safe_1.default.create({\n      ethAdapter: __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\"),\n      safeAddress,\n      isL1SafeMasterCopy: __classPrivateFieldGet(this, _SafeFactory_isL1SafeMasterCopy, \"f\"),\n      contractNetworks: __classPrivateFieldGet(this, _SafeFactory_contractNetworks, \"f\")\n    });\n    return safe;\n  }\n\n}\n\n_SafeFactory_contractNetworks = new WeakMap(), _SafeFactory_isL1SafeMasterCopy = new WeakMap(), _SafeFactory_safeVersion = new WeakMap(), _SafeFactory_ethAdapter = new WeakMap(), _SafeFactory_safeProxyFactoryContract = new WeakMap(), _SafeFactory_gnosisSafeContract = new WeakMap();\nexports.default = SafeFactory;","map":{"version":3,"sources":["../../../src/safeFactory/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __classPrivateFieldSet = (this && this.__classPrivateFieldSet) || function (receiver, state, value, kind, f) {\n    if (kind === \"m\") throw new TypeError(\"Private method is not writable\");\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a setter\");\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot write private member to an object whose class did not declare it\");\n    return (kind === \"a\" ? f.call(receiver, value) : f ? f.value = value : state.set(receiver, value)), value;\n};\nvar __classPrivateFieldGet = (this && this.__classPrivateFieldGet) || function (receiver, state, kind, f) {\n    if (kind === \"a\" && !f) throw new TypeError(\"Private accessor was defined without a getter\");\n    if (typeof state === \"function\" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError(\"Cannot read private member from an object whose class did not declare it\");\n    return kind === \"m\" ? f : kind === \"a\" ? f.call(receiver) : f ? f.value : state.get(receiver);\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nvar _SafeFactory_contractNetworks, _SafeFactory_isL1SafeMasterCopy, _SafeFactory_safeVersion, _SafeFactory_ethAdapter, _SafeFactory_safeProxyFactoryContract, _SafeFactory_gnosisSafeContract;\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst ethereumjs_util_1 = require(\"ethereumjs-util\");\nconst config_1 = require(\"../contracts/config\");\nconst safeDeploymentContracts_1 = require(\"../contracts/safeDeploymentContracts\");\nconst Safe_1 = __importDefault(require(\"../Safe\"));\nconst constants_1 = require(\"../utils/constants\");\nconst utils_1 = require(\"./utils\");\nclass SafeFactory {\n    constructor() {\n        _SafeFactory_contractNetworks.set(this, void 0);\n        _SafeFactory_isL1SafeMasterCopy.set(this, void 0);\n        _SafeFactory_safeVersion.set(this, void 0);\n        _SafeFactory_ethAdapter.set(this, void 0);\n        _SafeFactory_safeProxyFactoryContract.set(this, void 0);\n        _SafeFactory_gnosisSafeContract.set(this, void 0);\n    }\n    static async create({ ethAdapter, safeVersion = config_1.SAFE_LAST_VERSION, isL1SafeMasterCopy = false, contractNetworks }) {\n        const safeFactorySdk = new SafeFactory();\n        await safeFactorySdk.init({ ethAdapter, safeVersion, isL1SafeMasterCopy, contractNetworks });\n        return safeFactorySdk;\n    }\n    async init({ ethAdapter, safeVersion, isL1SafeMasterCopy, contractNetworks }) {\n        __classPrivateFieldSet(this, _SafeFactory_ethAdapter, ethAdapter, \"f\");\n        __classPrivateFieldSet(this, _SafeFactory_safeVersion, safeVersion, \"f\");\n        __classPrivateFieldSet(this, _SafeFactory_isL1SafeMasterCopy, isL1SafeMasterCopy, \"f\");\n        __classPrivateFieldSet(this, _SafeFactory_contractNetworks, contractNetworks, \"f\");\n        const chainId = await __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").getChainId();\n        const customContracts = contractNetworks === null || contractNetworks === void 0 ? void 0 : contractNetworks[chainId];\n        __classPrivateFieldSet(this, _SafeFactory_safeProxyFactoryContract, await (0, safeDeploymentContracts_1.getProxyFactoryContract)({\n            ethAdapter,\n            safeVersion,\n            chainId,\n            customContracts\n        }), \"f\");\n        __classPrivateFieldSet(this, _SafeFactory_gnosisSafeContract, await (0, safeDeploymentContracts_1.getSafeContract)({\n            ethAdapter,\n            safeVersion,\n            chainId,\n            isL1SafeMasterCopy,\n            customContracts\n        }), \"f\");\n    }\n    getEthAdapter() {\n        return __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\");\n    }\n    getSafeVersion() {\n        return __classPrivateFieldGet(this, _SafeFactory_safeVersion, \"f\");\n    }\n    getAddress() {\n        return __classPrivateFieldGet(this, _SafeFactory_safeProxyFactoryContract, \"f\").getAddress();\n    }\n    async getChainId() {\n        return __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").getChainId();\n    }\n    async encodeSetupCallData({ owners, threshold, to = constants_1.ZERO_ADDRESS, data = constants_1.EMPTY_DATA, fallbackHandler, paymentToken = constants_1.ZERO_ADDRESS, payment = 0, paymentReceiver = constants_1.ZERO_ADDRESS }) {\n        var _a;\n        let fallbackHandlerAddress;\n        if (fallbackHandler) {\n            fallbackHandlerAddress = fallbackHandler;\n        }\n        else {\n            const chainId = await __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").getChainId();\n            const customContracts = (_a = __classPrivateFieldGet(this, _SafeFactory_contractNetworks, \"f\")) === null || _a === void 0 ? void 0 : _a[chainId];\n            const fallbackHandlerContract = await (0, safeDeploymentContracts_1.getCompatibilityFallbackHandlerContract)({\n                ethAdapter: __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\"),\n                safeVersion: __classPrivateFieldGet(this, _SafeFactory_safeVersion, \"f\"),\n                chainId,\n                customContracts\n            });\n            fallbackHandlerAddress = fallbackHandlerContract.getAddress();\n        }\n        return __classPrivateFieldGet(this, _SafeFactory_gnosisSafeContract, \"f\").encode('setup', [\n            owners,\n            threshold,\n            to,\n            data,\n            fallbackHandlerAddress,\n            paymentToken,\n            payment,\n            paymentReceiver\n        ]);\n    }\n    async predictSafeAddress({ safeAccountConfig, safeDeploymentConfig }) {\n        (0, utils_1.validateSafeAccountConfig)(safeAccountConfig);\n        (0, utils_1.validateSafeDeploymentConfig)(safeDeploymentConfig);\n        const from = __classPrivateFieldGet(this, _SafeFactory_safeProxyFactoryContract, \"f\").getAddress();\n        const initializer = await this.encodeSetupCallData(safeAccountConfig);\n        const saltNonce = safeDeploymentConfig.saltNonce;\n        const encodedNonce = (0, ethereumjs_util_1.toBuffer)(__classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").encodeParameters(['uint256'], [saltNonce])).toString('hex');\n        const salt = (0, ethereumjs_util_1.keccak256)((0, ethereumjs_util_1.toBuffer)('0x' + (0, ethereumjs_util_1.keccak256)((0, ethereumjs_util_1.toBuffer)(initializer)).toString('hex') + encodedNonce));\n        const proxyCreationCode = await __classPrivateFieldGet(this, _SafeFactory_safeProxyFactoryContract, \"f\").proxyCreationCode();\n        const constructorData = (0, ethereumjs_util_1.toBuffer)(__classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").encodeParameters(['address'], [__classPrivateFieldGet(this, _SafeFactory_gnosisSafeContract, \"f\").getAddress()])).toString('hex');\n        const initCode = proxyCreationCode + constructorData;\n        const proxyAddress = '0x' + (0, ethereumjs_util_1.generateAddress2)((0, ethereumjs_util_1.toBuffer)(from), (0, ethereumjs_util_1.toBuffer)(salt), (0, ethereumjs_util_1.toBuffer)(initCode)).toString('hex');\n        return __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").getChecksummedAddress(proxyAddress);\n    }\n    async deploySafe({ safeAccountConfig, safeDeploymentConfig, options, callback }) {\n        var _a;\n        (0, utils_1.validateSafeAccountConfig)(safeAccountConfig);\n        if (safeDeploymentConfig) {\n            (0, utils_1.validateSafeDeploymentConfig)(safeDeploymentConfig);\n        }\n        const signerAddress = await __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").getSignerAddress();\n        if (!signerAddress) {\n            throw new Error('EthAdapter must be initialized with a signer to use this method');\n        }\n        const initializer = await this.encodeSetupCallData(safeAccountConfig);\n        const saltNonce = (_a = safeDeploymentConfig === null || safeDeploymentConfig === void 0 ? void 0 : safeDeploymentConfig.saltNonce) !== null && _a !== void 0 ? _a : (Date.now() * 1000 + Math.floor(Math.random() * 1000)).toString();\n        if ((options === null || options === void 0 ? void 0 : options.gas) && (options === null || options === void 0 ? void 0 : options.gasLimit)) {\n            throw new Error('Cannot specify gas and gasLimit together in transaction options');\n        }\n        const safeAddress = await __classPrivateFieldGet(this, _SafeFactory_safeProxyFactoryContract, \"f\").createProxy({\n            safeMasterCopyAddress: __classPrivateFieldGet(this, _SafeFactory_gnosisSafeContract, \"f\").getAddress(),\n            initializer,\n            saltNonce,\n            options: {\n                from: signerAddress,\n                ...options\n            },\n            callback\n        });\n        const isContractDeployed = await __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\").isContractDeployed(safeAddress);\n        if (!isContractDeployed) {\n            throw new Error('SafeProxy contract is not deployed on the current network');\n        }\n        const safe = await Safe_1.default.create({\n            ethAdapter: __classPrivateFieldGet(this, _SafeFactory_ethAdapter, \"f\"),\n            safeAddress,\n            isL1SafeMasterCopy: __classPrivateFieldGet(this, _SafeFactory_isL1SafeMasterCopy, \"f\"),\n            contractNetworks: __classPrivateFieldGet(this, _SafeFactory_contractNetworks, \"f\")\n        });\n        return safe;\n    }\n}\n_SafeFactory_contractNetworks = new WeakMap(), _SafeFactory_isL1SafeMasterCopy = new WeakMap(), _SafeFactory_safeVersion = new WeakMap(), _SafeFactory_ethAdapter = new WeakMap(), _SafeFactory_safeProxyFactoryContract = new WeakMap(), _SafeFactory_gnosisSafeContract = new WeakMap();\nexports.default = SafeFactory;\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"script"}